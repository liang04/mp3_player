/*
 * Simple SSD1306 OLED Driver for ESP32
 * Supports 128x32 displays via I2C
 */

#include "ssd1306_drv.h"
#include "esp_log.h"
#include <string.h>

static const char *TAG = "SSD1306";

// 8x16 font for better readability (ASCII 32-127)
// Each character is 8 pixels wide and 16 pixels tall (2 bytes per column)
static const uint8_t font8x16[][16] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00}, // Space (32)
    {0x00, 0x00, 0x00, 0xF8, 0xFC, 0xFC, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x33,
     0x33, 0x33, 0x00, 0x00}, // !
    {0x00, 0x0E, 0x1E, 0x00, 0x00, 0x0E, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00}, // "
    {0x20, 0xFC, 0xFC, 0x20, 0x20, 0xFC, 0xFC, 0x20, 0x04, 0x3F, 0x3F, 0x04,
     0x04, 0x3F, 0x3F, 0x04}, // #
    {0x38, 0x7C, 0x44, 0xFF, 0xFF, 0xC4, 0x9C, 0x18, 0x0C, 0x1C, 0x18, 0x7F,
     0x7F, 0x11, 0x1F, 0x0E}, // $
    {0x1C, 0x3E, 0x22, 0x3E, 0x9C, 0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x73,
     0xF9, 0x88, 0xF8, 0x70}, // %
    {0x00, 0xB8, 0xFC, 0x44, 0x6C, 0xB8, 0x80, 0x00, 0x1E, 0x3F, 0x21, 0x21,
     0x3F, 0x1E, 0x33, 0x21}, // &
    {0x00, 0x00, 0x00, 0x0E, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00}, // '
    {0x00, 0x00, 0xE0, 0xF8, 0x1C, 0x04, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x3F,
     0x70, 0x40, 0x00, 0x00}, // (
    {0x00, 0x00, 0x04, 0x1C, 0xF8, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x40, 0x70,
     0x3F, 0x0F, 0x00, 0x00}, // )
    {0x90, 0xB0, 0xE0, 0xFC, 0xFC, 0xE0, 0xB0, 0x90, 0x00, 0x00, 0x01, 0x07,
     0x07, 0x01, 0x00, 0x00}, // *
    {0x00, 0x80, 0x80, 0xF0, 0xF0, 0x80, 0x80, 0x00, 0x00, 0x01, 0x01, 0x0F,
     0x0F, 0x01, 0x01, 0x00}, // +
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0x60,
     0x00, 0x00, 0x00, 0x00}, // ,
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x01, 0x01, 0x01, 0x01,
     0x01, 0x01, 0x01, 0x01}, // -
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60,
     0x00, 0x00, 0x00, 0x00}, // .
    {0x00, 0x00, 0x00, 0xC0, 0xF0, 0x3C, 0x0E, 0x00, 0x60, 0x78, 0x1E, 0x07,
     0x01, 0x00, 0x00, 0x00}, // /
    {0xF0, 0xF8, 0x0C, 0x84, 0x44, 0x0C, 0xF8, 0xF0, 0x0F, 0x1F, 0x30, 0x21,
     0x22, 0x30, 0x1F, 0x0F}, // 0
    {0x00, 0x10, 0x18, 0xFC, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20, 0x3F,
     0x3F, 0x20, 0x20, 0x00}, // 1
    {0x08, 0x0C, 0x04, 0x04, 0x84, 0xCC, 0x78, 0x30, 0x20, 0x30, 0x38, 0x2C,
     0x27, 0x23, 0x20, 0x20}, // 2
    {0x08, 0x0C, 0x44, 0x44, 0x44, 0xCC, 0x98, 0x00, 0x10, 0x30, 0x20, 0x20,
     0x20, 0x31, 0x1F, 0x0E}, // 3
    {0x00, 0x80, 0xC0, 0x60, 0x30, 0xFC, 0xFC, 0x00, 0x06, 0x07, 0x05, 0x04,
     0x3F, 0x3F, 0x04, 0x04}, // 4
    {0x00, 0x7C, 0x7C, 0x44, 0x44, 0xC4, 0x84, 0x00, 0x10, 0x30, 0x20, 0x20,
     0x20, 0x38, 0x1F, 0x0F}, // 5
    {0xE0, 0xF0, 0x98, 0x4C, 0x44, 0xC4, 0x80, 0x00, 0x0F, 0x1F, 0x30, 0x20,
     0x20, 0x38, 0x1F, 0x07}, // 6
    {0x0C, 0x0C, 0x04, 0x04, 0xC4, 0xF4, 0x3C, 0x0C, 0x00, 0x00, 0x30, 0x3C,
     0x0F, 0x03, 0x00, 0x00}, // 7
    {0x98, 0xFC, 0x44, 0x44, 0x44, 0xFC, 0x98, 0x00, 0x19, 0x3F, 0x22, 0x22,
     0x22, 0x3F, 0x19, 0x00}, // 8
    {0x70, 0xF8, 0x8C, 0x04, 0x04, 0x8C, 0xF8, 0xF0, 0x00, 0x21, 0x23, 0x22,
     0x32, 0x19, 0x0F, 0x07}, // 9
    {0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18,
     0x18, 0x00, 0x00, 0x00}, // :
    {0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0,
     0x60, 0x00, 0x00, 0x00}, // ;
    {0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18, 0x08, 0x00, 0x01, 0x03, 0x06,
     0x0C, 0x18, 0x30, 0x20}, // <
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x02, 0x02, 0x02, 0x02,
     0x02, 0x02, 0x02, 0x02}, // =
    {0x08, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x20, 0x30, 0x18, 0x0C,
     0x06, 0x03, 0x01, 0x00}, // >
    {0x18, 0x1C, 0x04, 0xC4, 0xE4, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x37,
     0x37, 0x00, 0x00, 0x00}, // ?
    {0xF0, 0xF8, 0x0C, 0xE4, 0xF4, 0x14, 0xF4, 0xE0, 0x0F, 0x1F, 0x30, 0x27,
     0x2F, 0x28, 0x2F, 0x0F}, // @
    {0x00, 0x00, 0xE0, 0xF8, 0x1E, 0xF8, 0xE0, 0x00, 0x20, 0x3C, 0x3F, 0x23,
     0x23, 0x3F, 0x3C, 0x20}, // A
    {0x04, 0xFC, 0xFC, 0x44, 0x44, 0xFC, 0xB8, 0x00, 0x20, 0x3F, 0x3F, 0x22,
     0x22, 0x3F, 0x1D, 0x00}, // B
    {0xF0, 0xF8, 0x0C, 0x04, 0x04, 0x0C, 0x18, 0x00, 0x0F, 0x1F, 0x30, 0x20,
     0x20, 0x30, 0x18, 0x00}, // C
    {0x04, 0xFC, 0xFC, 0x04, 0x0C, 0x18, 0xF0, 0xE0, 0x20, 0x3F, 0x3F, 0x20,
     0x30, 0x18, 0x0F, 0x07}, // D
    {0x04, 0xFC, 0xFC, 0x44, 0xE4, 0x0C, 0x1C, 0x00, 0x20, 0x3F, 0x3F, 0x22,
     0x27, 0x30, 0x38, 0x00}, // E
    {0x04, 0xFC, 0xFC, 0x44, 0xE4, 0x0C, 0x1C, 0x00, 0x20, 0x3F, 0x3F, 0x22,
     0x07, 0x00, 0x00, 0x00}, // F
    {0xF0, 0xF8, 0x0C, 0x04, 0x44, 0xCC, 0xD8, 0x00, 0x0F, 0x1F, 0x30, 0x20,
     0x22, 0x3F, 0x1F, 0x02}, // G
    {0x04, 0xFC, 0xFC, 0x40, 0x40, 0xFC, 0xFC, 0x04, 0x20, 0x3F, 0x3F, 0x02,
     0x02, 0x3F, 0x3F, 0x20}, // H
    {0x00, 0x00, 0x04, 0xFC, 0xFC, 0x04, 0x00, 0x00, 0x00, 0x00, 0x20, 0x3F,
     0x3F, 0x20, 0x00, 0x00}, // I
    {0x00, 0x00, 0x00, 0x04, 0xFC, 0xFC, 0x04, 0x00, 0x18, 0x38, 0x30, 0x20,
     0x3F, 0x1F, 0x00, 0x00}, // J
    {0x04, 0xFC, 0xFC, 0xC0, 0xF0, 0x3C, 0x0C, 0x04, 0x20, 0x3F, 0x3F, 0x03,
     0x07, 0x3C, 0x38, 0x20}, // K
    {0x04, 0xFC, 0xFC, 0x04, 0x00, 0x00, 0x00, 0x00, 0x20, 0x3F, 0x3F, 0x20,
     0x20, 0x30, 0x38, 0x00}, // L
    {0xFC, 0xFC, 0x38, 0xE0, 0xE0, 0x38, 0xFC, 0xFC, 0x3F, 0x3F, 0x00, 0x01,
     0x01, 0x00, 0x3F, 0x3F}, // M
    {0xFC, 0xFC, 0x18, 0x70, 0xE0, 0x80, 0xFC, 0xFC, 0x3F, 0x3F, 0x00, 0x00,
     0x01, 0x07, 0x3F, 0x3F}, // N
    {0xF0, 0xF8, 0x0C, 0x04, 0x04, 0x0C, 0xF8, 0xF0, 0x0F, 0x1F, 0x30, 0x20,
     0x20, 0x30, 0x1F, 0x0F}, // O
    {0x04, 0xFC, 0xFC, 0x44, 0x44, 0x7C, 0x38, 0x00, 0x20, 0x3F, 0x3F, 0x22,
     0x02, 0x03, 0x01, 0x00}, // P
    {0xF0, 0xF8, 0x0C, 0x04, 0x04, 0x0C, 0xF8, 0xF0, 0x0F, 0x1F, 0x30, 0x32,
     0x3C, 0x78, 0x5F, 0x4F}, // Q
    {0x04, 0xFC, 0xFC, 0x44, 0xC4, 0xFC, 0x38, 0x00, 0x20, 0x3F, 0x3F, 0x02,
     0x03, 0x3F, 0x3D, 0x20}, // R
    {0x38, 0x7C, 0x44, 0xC4, 0x84, 0x9C, 0x18, 0x00, 0x18, 0x39, 0x21, 0x23,
     0x22, 0x3E, 0x1C, 0x00}, // S
    {0x00, 0x1C, 0x0C, 0xFC, 0xFC, 0x0C, 0x1C, 0x00, 0x00, 0x00, 0x20, 0x3F,
     0x3F, 0x20, 0x00, 0x00}, // T
    {0x04, 0xFC, 0xFC, 0x00, 0x00, 0xFC, 0xFC, 0x04, 0x00, 0x1F, 0x3F, 0x20,
     0x20, 0x3F, 0x1F, 0x00}, // U
    {0x04, 0x3C, 0xFC, 0xC0, 0xC0, 0xFC, 0x3C, 0x04, 0x00, 0x00, 0x07, 0x3F,
     0x3F, 0x07, 0x00, 0x00}, // V
    {0x1C, 0xFC, 0xE0, 0x80, 0x80, 0xE0, 0xFC, 0x1C, 0x00, 0x1F, 0x3F, 0x07,
     0x07, 0x3F, 0x1F, 0x00}, // W
    {0x04, 0x1C, 0x38, 0xE0, 0xE0, 0x38, 0x1C, 0x04, 0x20, 0x38, 0x1C, 0x07,
     0x07, 0x1C, 0x38, 0x20}, // X
    {0x04, 0x1C, 0x3C, 0xE0, 0xE0, 0x3C, 0x1C, 0x04, 0x00, 0x00, 0x20, 0x3F,
     0x3F, 0x20, 0x00, 0x00}, // Y
    {0x1C, 0x0C, 0x04, 0xC4, 0xE4, 0x3C, 0x1C, 0x00, 0x38, 0x3C, 0x27, 0x23,
     0x20, 0x30, 0x38, 0x00}, // Z
    {0x00, 0x00, 0xFC, 0xFC, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x7F,
     0x40, 0x40, 0x00, 0x00}, // [
    {0x0E, 0x3C, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07,
     0x1E, 0x78, 0x60, 0x00}, // BackSlash
    {0x00, 0x00, 0x04, 0x04, 0xFC, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40,
     0x7F, 0x7F, 0x00, 0x00}, // ]
    {0x00, 0x08, 0x0C, 0x06, 0x06, 0x0C, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00}, // ^
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80,
     0x80, 0x80, 0x80, 0x80}, // _
    {0x00, 0x00, 0x02, 0x06, 0x0C, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00}, // `
    {0x00, 0x20, 0x30, 0x10, 0x10, 0xF0, 0xE0, 0x00, 0x1C, 0x3E, 0x22, 0x22,
     0x1F, 0x3F, 0x20, 0x00}, // a
    {0x04, 0xFC, 0xFC, 0x20, 0x10, 0xF0, 0xE0, 0x00, 0x00, 0x3F, 0x3F, 0x20,
     0x20, 0x3F, 0x1F, 0x00}, // b
    {0x00, 0xE0, 0xF0, 0x10, 0x10, 0x30, 0x20, 0x00, 0x00, 0x1F, 0x3F, 0x20,
     0x20, 0x30, 0x10, 0x00}, // c
    {0x00, 0xE0, 0xF0, 0x10, 0x14, 0xFC, 0xFC, 0x00, 0x00, 0x1F, 0x3F, 0x20,
     0x20, 0x3F, 0x3F, 0x20}, // d
    {0x00, 0xE0, 0xF0, 0x90, 0x90, 0xF0, 0xE0, 0x00, 0x00, 0x1F, 0x3F, 0x22,
     0x22, 0x23, 0x03, 0x00}, // e
    {0x10, 0xF8, 0xFC, 0x14, 0x1C, 0x18, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x20,
     0x00, 0x00, 0x00, 0x00}, // f
    {0x00, 0xE0, 0xF0, 0x10, 0x10, 0xF0, 0xF0, 0x00, 0x00, 0x47, 0xCF, 0x88,
     0x88, 0xFF, 0x7F, 0x00}, // g
    {0x04, 0xFC, 0xFC, 0x20, 0x10, 0xF0, 0xE0, 0x00, 0x20, 0x3F, 0x3F, 0x00,
     0x00, 0x3F, 0x3F, 0x20}, // h
    {0x00, 0x00, 0x10, 0xF4, 0xF4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x3F,
     0x3F, 0x20, 0x00, 0x00}, // i
    {0x00, 0x00, 0x00, 0x10, 0xF4, 0xF4, 0x00, 0x00, 0x00, 0x60, 0xE0, 0x80,
     0xFF, 0x7F, 0x00, 0x00}, // j
    {0x04, 0xFC, 0xFC, 0x80, 0xE0, 0x70, 0x10, 0x00, 0x20, 0x3F, 0x3F, 0x03,
     0x0F, 0x3C, 0x30, 0x20}, // k
    {0x00, 0x00, 0x04, 0xFC, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x3F,
     0x3F, 0x20, 0x00, 0x00}, // l
    {0xF0, 0xF0, 0x10, 0xF0, 0x10, 0xF0, 0xE0, 0x00, 0x3F, 0x3F, 0x00, 0x3F,
     0x00, 0x3F, 0x3F, 0x00}, // m
    {0x10, 0xF0, 0xE0, 0x20, 0x10, 0xF0, 0xE0, 0x00, 0x00, 0x3F, 0x3F, 0x00,
     0x00, 0x3F, 0x3F, 0x00}, // n
    {0x00, 0xE0, 0xF0, 0x10, 0x10, 0xF0, 0xE0, 0x00, 0x00, 0x1F, 0x3F, 0x20,
     0x20, 0x3F, 0x1F, 0x00}, // o
    {0x10, 0xF0, 0xF0, 0x10, 0x10, 0xF0, 0xE0, 0x00, 0x80, 0xFF, 0xFF, 0x88,
     0x08, 0x0F, 0x07, 0x00}, // p
    {0x00, 0xE0, 0xF0, 0x10, 0x10, 0xF0, 0xF0, 0x00, 0x00, 0x07, 0x0F, 0x08,
     0x88, 0xFF, 0xFF, 0x80}, // q
    {0x10, 0xF0, 0xE0, 0x30, 0x10, 0x30, 0x00, 0x00, 0x20, 0x3F, 0x3F, 0x20,
     0x00, 0x00, 0x00, 0x00}, // r
    {0x00, 0x60, 0xF0, 0x90, 0x10, 0x30, 0x20, 0x00, 0x00, 0x31, 0x23, 0x22,
     0x26, 0x3E, 0x1C, 0x00}, // s
    {0x10, 0x10, 0xFC, 0xFC, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x3F,
     0x20, 0x30, 0x00, 0x00}, // t
    {0x10, 0xF0, 0xF0, 0x00, 0x10, 0xF0, 0xF0, 0x00, 0x00, 0x1F, 0x3F, 0x20,
     0x20, 0x3F, 0x3F, 0x20}, // u
    {0x10, 0xF0, 0xE0, 0x00, 0x00, 0xE0, 0xF0, 0x10, 0x00, 0x00, 0x0F, 0x3F,
     0x3F, 0x0F, 0x00, 0x00}, // v
    {0xF0, 0xF0, 0x00, 0xE0, 0x00, 0xF0, 0xF0, 0x00, 0x07, 0x3F, 0x3C, 0x07,
     0x3C, 0x3F, 0x07, 0x00}, // w
    {0x10, 0x30, 0xE0, 0xC0, 0xC0, 0xE0, 0x30, 0x10, 0x20, 0x30, 0x1C, 0x07,
     0x07, 0x1C, 0x30, 0x20}, // x
    {0x10, 0x70, 0xE0, 0x80, 0x80, 0xE0, 0x70, 0x10, 0x00, 0x80, 0xC3, 0x7F,
     0x7F, 0x03, 0x00, 0x00}, // y
    {0x30, 0x30, 0x10, 0x90, 0xD0, 0x70, 0x30, 0x00, 0x30, 0x38, 0x2C, 0x27,
     0x23, 0x30, 0x30, 0x00}, // z
    {0x00, 0x00, 0x80, 0xFC, 0x7C, 0x04, 0x04, 0x00, 0x00, 0x00, 0x01, 0x3F,
     0x7E, 0x40, 0x40, 0x00}, // {
    {0x00, 0x00, 0x00, 0xFC, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
     0xFF, 0x00, 0x00, 0x00}, // |
    {0x00, 0x04, 0x04, 0x7C, 0xFC, 0x80, 0x00, 0x00, 0x00, 0x40, 0x40, 0x7E,
     0x3F, 0x01, 0x00, 0x00}, // }
    {0x00, 0xC0, 0x60, 0x60, 0xC0, 0x80, 0xC0, 0x60, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00}, // ~
};

/**
 * @brief Write command to SSD1306
 */
static esp_err_t ssd1306_write_cmd(i2c_port_t i2c_num, uint8_t cmd) {
  uint8_t data[2] = {0x00, cmd}; // 0x00 = command mode
  return i2c_master_write_to_device(i2c_num, SSD1306_I2C_ADDR, data, 2,
                                    1000 / portTICK_PERIOD_MS);
}

/**
 * @brief Write data to SSD1306
 */
static esp_err_t ssd1306_write_data(i2c_port_t i2c_num, const uint8_t *data,
                                    size_t len) {
  uint8_t buf[len + 1];
  buf[0] = 0x40; // 0x40 = data mode
  memcpy(buf + 1, data, len);
  return i2c_master_write_to_device(i2c_num, SSD1306_I2C_ADDR, buf, len + 1,
                                    1000 / portTICK_PERIOD_MS);
}

esp_err_t ssd1306_init(i2c_port_t i2c_num) {
  esp_err_t ret;

  // Display off
  ret = ssd1306_write_cmd(i2c_num, SSD1306_CMD_DISPLAY_OFF);
  if (ret != ESP_OK)
    return ret;

  // Set display clock divide ratio/oscillator frequency
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_DISPLAY_CLOCK_DIV);
  ssd1306_write_cmd(i2c_num, 0x80);

  // Set multiplex ratio (1 to 64)
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_MULTIPLEX);
  ssd1306_write_cmd(i2c_num, SSD1306_HEIGHT - 1);

  // Set display offset
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_DISPLAY_OFFSET);
  ssd1306_write_cmd(i2c_num, 0x00);

  // Set start line
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_START_LINE | 0x00);

  // Enable charge pump
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_CHARGE_PUMP);
  ssd1306_write_cmd(i2c_num, 0x14);

  // Set memory addressing mode (horizontal)
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_MEMORY_MODE);
  ssd1306_write_cmd(i2c_num, 0x00);

  // Set segment re-map
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_SEGMENT_REMAP);

  // Set COM output scan direction
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_COM_SCAN_DEC);

  // Set COM pins hardware configuration
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_COM_PINS);
  ssd1306_write_cmd(i2c_num, 0x02); // For 128x32

  // Set contrast
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_CONTRAST);
  ssd1306_write_cmd(i2c_num, 0xFF);

  // Set precharge period
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_PRECHARGE);
  ssd1306_write_cmd(i2c_num, 0xF1);

  // Set VCOMH deselect level
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_VCOM_DETECT);
  ssd1306_write_cmd(i2c_num, 0x40);

  // Entire display on (resume)
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_ENTIRE_DISPLAY_ON);

  // Normal display (not inverted)
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_NORMAL_DISPLAY);

  // Display on
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_DISPLAY_ON);

  ESP_LOGI(TAG, "SSD1306 initialized");
  return ESP_OK;
}

void ssd1306_clear(i2c_port_t i2c_num) {
  // Set column address
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_COLUMN_ADDR);
  ssd1306_write_cmd(i2c_num, 0);                 // Start column
  ssd1306_write_cmd(i2c_num, SSD1306_WIDTH - 1); // End column

  // Set page address
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_PAGE_ADDR);
  ssd1306_write_cmd(i2c_num, 0);                        // Start page
  ssd1306_write_cmd(i2c_num, (SSD1306_HEIGHT / 8) - 1); // End page

  // Clear display
  uint8_t zeros[128] = {0};
  for (int i = 0; i < SSD1306_HEIGHT / 8; i++) {
    ssd1306_write_data(i2c_num, zeros, 128);
  }
}

void ssd1306_text(i2c_port_t i2c_num, uint8_t page, const char *text) {
  // For 8x16 font, each character occupies 2 pages
  // page 0 = lines 0-1, page 2 = lines 2-3
  if (page >= SSD1306_HEIGHT / 8)
    return;

  size_t text_len = strlen(text);
  if (text_len > (SSD1306_WIDTH / 8))
    text_len = SSD1306_WIDTH / 8; // Max 16 characters per line

  // Set page range (2 pages for 8x16 font)
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_PAGE_ADDR);
  ssd1306_write_cmd(i2c_num, page);
  ssd1306_write_cmd(i2c_num, page + 1); // Cover 2 pages for tall font

  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_COLUMN_ADDR);
  ssd1306_write_cmd(i2c_num, 0);
  ssd1306_write_cmd(i2c_num, SSD1306_WIDTH - 1);

  // Write first half (top 8 pixels) of all characters
  for (size_t i = 0; i < text_len; i++) {
    char c = text[i];
    if (c >= 32 && c <= 126) {
      // Write first 8 bytes (top half of character)
      ssd1306_write_data(i2c_num, &font8x16[c - 32][0], 8);
    } else {
      // Space for unsupported characters
      uint8_t space[8] = {0};
      ssd1306_write_data(i2c_num, space, 8);
    }
  }

  // Fill rest of first page with zeros
  uint8_t zeros[8] = {0};
  for (size_t i = text_len; i < (SSD1306_WIDTH / 8); i++) {
    ssd1306_write_data(i2c_num, zeros, 8);
  }

  // Set page for second half
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_PAGE_ADDR);
  ssd1306_write_cmd(i2c_num, page + 1);
  ssd1306_write_cmd(i2c_num, page + 1);

  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_COLUMN_ADDR);
  ssd1306_write_cmd(i2c_num, 0);
  ssd1306_write_cmd(i2c_num, SSD1306_WIDTH - 1);

  // Write second half (bottom 8 pixels) of all characters
  for (size_t i = 0; i < text_len; i++) {
    char c = text[i];
    if (c >= 32 && c <= 126) {
      // Write second 8 bytes (bottom half of character)
      ssd1306_write_data(i2c_num, &font8x16[c - 32][8], 8);
    } else {
      // Space for unsupported characters
      uint8_t space[8] = {0};
      ssd1306_write_data(i2c_num, space, 8);
    }
  }

  // Fill rest of second page with zeros
  for (size_t i = text_len; i < (SSD1306_WIDTH / 8); i++) {
    ssd1306_write_data(i2c_num, zeros, 8);
  }
}

void ssd1306_contrast(i2c_port_t i2c_num, uint8_t contrast) {
  ssd1306_write_cmd(i2c_num, SSD1306_CMD_SET_CONTRAST);
  ssd1306_write_cmd(i2c_num, contrast);
}
